/**
 * Example: Running AdversarialBot for Exploit Testing
 *
 * This example demonstrates how to use the AdversarialBot to find
 * vulnerabilities and edge cases in the game.
 */

import { AdversarialBot } from './AdversarialBot.js';

async function runBasicExploitTest() {
  console.log('Example 1: Basic Exploit Testing');
  console.log('='.repeat(60));

  const bot = new AdversarialBot({
    name: 'BasicChaosTest',
    username: 'exploit_tester',
    email: 'exploit@test.com',
    password: 'Test1234!',
    characterName: 'ExploitTester',
    baseUrl: 'http://localhost:3002',
    headless: false,
    slowMo: 50,
  });

  try {
    await bot.start();
    console.log('âœ“ Basic exploit testing completed');
  } catch (error) {
    console.error('âœ— Error:', error);
  }
}

async function runFocusedExploitTest() {
  console.log('\nExample 2: Focused Testing (Gold Economy Only)');
  console.log('='.repeat(60));

  // You can create custom bots that extend AdversarialBot
  // and override runBehaviorLoop to test specific systems

  const bot = new AdversarialBot({
    name: 'GoldExploitTest',
    username: 'gold_tester',
    email: 'gold@test.com',
    password: 'Test1234!',
    characterName: 'GoldTester',
    baseUrl: 'http://localhost:3002',
    headless: true,
  });

  try {
    await bot.start();
    console.log('âœ“ Gold economy exploit testing completed');
  } catch (error) {
    console.error('âœ— Error:', error);
  }
}

async function runContinuousExploitTesting() {
  console.log('\nExample 3: Continuous Exploit Testing (Multiple Runs)');
  console.log('='.repeat(60));

  // Run multiple instances with different configurations
  const testRuns = [
    {
      name: 'FastChaos',
      slowMo: 0, // No delay - maximum speed
    },
    {
      name: 'SlowChaos',
      slowMo: 200, // Slow down to catch timing-dependent bugs
    },
    {
      name: 'HeadlessChaos',
      headless: true, // Run in background
    },
  ];

  for (const config of testRuns) {
    console.log(`\nRunning: ${config.name}`);

    const bot = new AdversarialBot({
      name: config.name,
      username: `${config.name.toLowerCase()}_user`,
      email: `${config.name.toLowerCase()}@test.com`,
      password: 'Test1234!',
      characterName: `${config.name}Character`,
      baseUrl: 'http://localhost:3002',
      headless: config.headless || false,
      slowMo: config.slowMo || 50,
    });

    try {
      await bot.start();
      console.log(`âœ“ ${config.name} completed`);
    } catch (error) {
      console.error(`âœ— ${config.name} failed:`, error);
    }

    // Wait between runs
    await new Promise(resolve => setTimeout(resolve, 5000));
  }
}

// Example of analyzing exploit reports
async function analyzeExploitReports() {
  console.log('\nExample 4: Analyzing Exploit Reports');
  console.log('='.repeat(60));

  const fs = await import('fs');
  const path = await import('path');

  const reportsDir = path.join(process.cwd(), 'tests', 'playtests', 'reports');

  try {
    const files = fs.readdirSync(reportsDir)
      .filter(f => f.startsWith('adversarial-bot-report-'))
      .sort()
      .reverse(); // Most recent first

    if (files.length === 0) {
      console.log('No exploit reports found. Run AdversarialBot first!');
      return;
    }

    console.log(`Found ${files.length} exploit reports`);

    // Read most recent report
    const latestReport = files[0];
    const reportPath = path.join(reportsDir, latestReport);
    const reportData = JSON.parse(fs.readFileSync(reportPath, 'utf-8'));

    console.log('\nLatest Report Summary:');
    console.log(`  Date: ${new Date(reportData.metadata.timestamp).toISOString()}`);
    console.log(`  Tests Run: ${reportData.metadata.testsRun}`);
    console.log(`  Exploits Found: ${reportData.metadata.exploitsFound}`);
    console.log('\nSeverity Breakdown:');
    console.log(`  CRITICAL: ${reportData.summary.critical}`);
    console.log(`  HIGH:     ${reportData.summary.high}`);
    console.log(`  MEDIUM:   ${reportData.summary.medium}`);
    console.log(`  LOW:      ${reportData.summary.low}`);

    // Show critical exploits
    const criticalExploits = reportData.exploits.filter((e: any) => e.severity === 'CRITICAL');

    if (criticalExploits.length > 0) {
      console.log('\nâš ï¸  CRITICAL EXPLOITS FOUND:');
      criticalExploits.forEach((exploit: any, i: number) => {
        console.log(`\n${i + 1}. ${exploit.title}`);
        console.log(`   Category: ${exploit.category}`);
        console.log(`   Impact: ${exploit.impact}`);
        console.log(`   Fix: ${exploit.recommendation}`);
      });
    }

    // Compare with previous report
    if (files.length > 1) {
      const previousReport = files[1];
      const previousPath = path.join(reportsDir, previousReport);
      const previousData = JSON.parse(fs.readFileSync(previousPath, 'utf-8'));

      const exploitChange = reportData.metadata.exploitsFound - previousData.metadata.exploitsFound;

      console.log('\nðŸ“Š Comparison with Previous Run:');
      console.log(`  Exploit Count Change: ${exploitChange > 0 ? '+' : ''}${exploitChange}`);

      if (exploitChange < 0) {
        console.log('  âœ“ Fewer exploits found - security is improving!');
      } else if (exploitChange > 0) {
        console.log('  âš ï¸  More exploits found - new vulnerabilities detected!');
      } else {
        console.log('  â†’ No change in exploit count');
      }
    }

  } catch (error) {
    console.error('Error analyzing reports:', error);
  }
}

// Main execution
async function main() {
  const args = process.argv.slice(2);
  const example = args[0] || '1';

  console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘     AdversarialBot Examples - Exploit Testing              â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  switch (example) {
    case '1':
      await runBasicExploitTest();
      break;

    case '2':
      await runFocusedExploitTest();
      break;

    case '3':
      await runContinuousExploitTesting();
      break;

    case '4':
      await analyzeExploitReports();
      break;

    case 'all':
      await runBasicExploitTest();
      await new Promise(resolve => setTimeout(resolve, 3000));
      await runFocusedExploitTest();
      await new Promise(resolve => setTimeout(resolve, 3000));
      await analyzeExploitReports();
      break;

    default:
      console.log('Usage: npm run example:exploits [1|2|3|4|all]');
      console.log('\nExamples:');
      console.log('  1 - Basic exploit testing');
      console.log('  2 - Focused testing (gold economy)');
      console.log('  3 - Continuous testing (multiple runs)');
      console.log('  4 - Analyze exploit reports');
      console.log('  all - Run all examples');
      break;
  }
}

// Run if executed directly
if (import.meta.url === `file://${process.argv[1]}`) {
  main().catch(console.error);
}

export {
  runBasicExploitTest,
  runFocusedExploitTest,
  runContinuousExploitTesting,
  analyzeExploitReports,
};
