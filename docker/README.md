# DOCKER CONFIGURATION

This directory contains Docker-related configuration files for Desperados Destiny.

---

## Directory Structure

```
docker/
├── mongo-init/          # MongoDB initialization scripts
│   └── init.js          # Database setup script (auto-generated by npm run setup)
└── README.md            # This file
```

---

## MongoDB Initialization

The `mongo-init/init.js` script runs automatically when the MongoDB container is first created.

It performs:
- Database creation
- Collection creation
- Index creation
- Initial data seeding (if needed)

**Note:** This script only runs on the first container creation. To re-run:

```bash
# Remove MongoDB volume and restart
docker-compose down -v
docker-compose up mongodb
```

---

## Docker Compose Services

See the root `docker-compose.yml` file for service definitions:

- **mongodb** - MongoDB 6.x database
- **redis** - Redis 7.x cache
- **backend** - Node.js API server
- **frontend** - React development server

---

## Customizing Docker Configuration

### Override Docker Compose Settings

Create a `docker-compose.override.yml` file (gitignored) for local customizations:

```yaml
version: '3.8'

services:
  backend:
    ports:
      - "5001:5000"  # Change backend port
    environment:
      LOG_LEVEL: debug  # Increase logging
```

### Custom MongoDB Init Scripts

Add additional `.js` or `.sh` files to `mongo-init/` to run on container creation.

Files are executed in alphabetical order.

---

## Volumes

Docker volumes persist data between container restarts:

- `mongodb_data` - MongoDB database files
- `mongodb_config` - MongoDB configuration
- `redis_data` - Redis persistence files
- `backend_logs` - Backend application logs

### View Volumes

```bash
docker volume ls
```

### Inspect a Volume

```bash
docker volume inspect desperados-destiny_mongodb_data
```

### Remove Volumes

```bash
# Stop and remove volumes
docker-compose down -v

# Or use the npm script
npm run stop:clean
```

---

## Health Checks

All services include health checks to ensure they're ready:

### Check Service Health

```bash
# View service status
docker-compose ps

# Check specific service health
docker inspect --format='{{.State.Health.Status}}' desperados-backend
```

### Health Check Endpoints

- **MongoDB:** `mongosh ping` command
- **Redis:** `redis-cli incr ping` command
- **Backend:** `GET /health` endpoint
- **Frontend:** HTTP GET to `/`

---

## Networking

All services communicate via the `desperados-network` bridge network.

Service discovery works via service names:
- `mongodb` - MongoDB host
- `redis` - Redis host
- `backend` - Backend API host
- `frontend` - Frontend host

Example connection string from backend:
```
mongodb://mongodb:27017/desperados-destiny
```

---

## Useful Docker Commands

```bash
# Start services in background
docker-compose up -d

# Stop services
docker-compose down

# Restart a service
docker-compose restart backend

# Rebuild a service
docker-compose up --build backend

# Execute command in container
docker-compose exec backend sh

# View resource usage
docker stats

# Remove everything (nuclear option)
docker-compose down -v
docker system prune -a --volumes
```

---

For more information, see the root [DEVELOPMENT.md](../DEVELOPMENT.md).
