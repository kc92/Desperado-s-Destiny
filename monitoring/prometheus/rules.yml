# =============================================================================
# PROMETHEUS ALERT RULES - DESPERADOS DESTINY
# =============================================================================
# Defines when to trigger alerts based on metrics
# =============================================================================

groups:
  # ---------------------------------------------------------------------------
  # Critical Application Alerts
  # ---------------------------------------------------------------------------
  - name: application_critical
    interval: 30s
    rules:
      # High error rate
      - alert: HighErrorRate
        expr: |
          (rate(http_requests_total{status=~"5.."}[5m]) /
           rate(http_requests_total[5m])) > 0.01
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} for {{ $labels.instance }}"

      # Slow response time (p95 > 2 seconds)
      - alert: SlowResponseTime
        expr: |
          histogram_quantile(0.95,
            rate(http_request_duration_seconds_bucket[5m])
          ) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow API response times"
          description: "P95 response time is {{ $value }}s on {{ $labels.instance }}"

      # Service down
      - alert: ServiceDown
        expr: up{job="desperados-server"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Desperados server is down"
          description: "Server {{ $labels.instance }} has been down for more than 1 minute"

  # ---------------------------------------------------------------------------
  # Resource Usage Alerts
  # ---------------------------------------------------------------------------
  - name: resource_usage
    interval: 30s
    rules:
      # High memory usage (> 85%)
      - alert: HighMemoryUsage
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"

      # High CPU usage (> 80%)
      - alert: HighCPUUsage
        expr: |
          100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value }}% on {{ $labels.instance }}"

      # Low disk space (< 15%)
      - alert: LowDiskSpace
        expr: |
          (node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.lxcfs"} /
           node_filesystem_size_bytes{fstype!~"tmpfs|fuse.lxcfs"}) < 0.15
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Low disk space"
          description: "Disk usage is {{ $value | humanizePercentage }} on {{ $labels.instance }} {{ $labels.mountpoint }}"

  # ---------------------------------------------------------------------------
  # Database and Dependencies
  # ---------------------------------------------------------------------------
  - name: dependencies
    interval: 30s
    rules:
      # MongoDB connection failures
      - alert: MongoDBConnectionFailure
        expr: |
          rate(mongodb_connections_failed_total[5m]) > 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "MongoDB connection failures detected"
          description: "MongoDB is experiencing connection failures on {{ $labels.instance }}"

      # Redis connection failures
      - alert: RedisConnectionFailure
        expr: |
          rate(redis_connections_rejected_total[5m]) > 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Redis connection failures detected"
          description: "Redis is rejecting connections on {{ $labels.instance }}"

  # ---------------------------------------------------------------------------
  # Business Metrics
  # ---------------------------------------------------------------------------
  - name: business_metrics
    interval: 1m
    rules:
      # No active players (potential issue)
      - alert: NoActivePlayers
        expr: |
          active_players_total == 0
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "No active players"
          description: "No active players for 10 minutes - possible service issue"

      # Abnormally high player count (DDoS or bot attack)
      - alert: AbnormalPlayerCount
        expr: |
          active_players_total > 10000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Abnormally high player count"
          description: "Player count ({{ $value }}) is abnormally high - possible attack"

  # ---------------------------------------------------------------------------
  # Transaction and Revenue Alerts
  # ---------------------------------------------------------------------------
  - name: revenue_critical
    interval: 1m
    rules:
      # No transactions for extended period
      - alert: NoTransactions
        expr: |
          rate(shop_purchases_total[30m]) == 0
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "No shop transactions"
          description: "No shop purchases in 30 minutes - potential issue"

      # High transaction failure rate
      - alert: HighTransactionFailureRate
        expr: |
          (rate(shop_purchase_failures_total[5m]) /
           rate(shop_purchases_total[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High transaction failure rate"
          description: "Transaction failure rate is {{ $value | humanizePercentage }}"
