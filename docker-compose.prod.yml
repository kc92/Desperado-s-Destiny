# Docker Compose Production Configuration
#
# This configuration is optimized for production deployment.
# Use with: docker-compose -f docker-compose.prod.yml up -d
#
# Prerequisites:
# 1. Set all environment variables in .env file
# 2. Configure external MongoDB Atlas and Redis Cloud
# 3. Set up reverse proxy (Nginx) for SSL termination

services:
  # ============================================================
  # Game Server
  # ============================================================
  server:
    build:
      context: .
      dockerfile: ./server/Dockerfile
      target: production
    container_name: desperados-server
    restart: unless-stopped

    # Resource limits to prevent runaway processes
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    environment:
      NODE_ENV: production
      PORT: 3001
      MONGODB_URI: ${MONGODB_URI:?MONGODB_URI is required}
      REDIS_URL: ${REDIS_URL:?REDIS_URL is required}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:?JWT_REFRESH_SECRET is required}
      SESSION_SECRET: ${SESSION_SECRET:?SESSION_SECRET is required}
      FRONTEND_URL: ${FRONTEND_URL:?FRONTEND_URL is required}
      SENTRY_DSN: ${SENTRY_DSN:-}

    ports:
      - "3001:3001"

    # Health check for container orchestration
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

    networks:
      - desperados-network

  # ============================================================
  # Client (Static Files / Nginx)
  # ============================================================
  client:
    build:
      context: .
      dockerfile: ./client/Dockerfile
      target: production
      args:
        VITE_API_URL: ${FRONTEND_API_URL:-https://api.yourdomain.com}
        VITE_WS_URL: ${FRONTEND_WS_URL:-wss://api.yourdomain.com}
    container_name: desperados-client
    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

    ports:
      - "80:80"
      - "443:443"

    volumes:
      # SSL certificates - mount from host
      - ./deploy/ssl:/etc/nginx/ssl:ro
      # Nginx config - mount from host
      - ./deploy/nginx.conf:/etc/nginx/conf.d/default.conf:ro

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

    depends_on:
      server:
        condition: service_healthy

    networks:
      - desperados-network

  # ============================================================
  # Prometheus (Monitoring)
  # ============================================================
  prometheus:
    image: prom/prometheus:v2.47.0
    container_name: desperados-prometheus
    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus-alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus

    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'

    ports:
      - "9090:9090"

    networks:
      - desperados-network

  # ============================================================
  # Grafana (Dashboards)
  # ============================================================
  grafana:
    image: grafana/grafana:10.1.0
    container_name: desperados-grafana
    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-changeme}
      - GF_USERS_ALLOW_SIGN_UP=false

    volumes:
      - grafana-data:/var/lib/grafana

    ports:
      - "3000:3000"

    depends_on:
      - prometheus

    networks:
      - desperados-network

networks:
  desperados-network:
    driver: bridge

volumes:
  prometheus-data:
  grafana-data:
